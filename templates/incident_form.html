{% extends "base.html" %}

{% block title %}{% if incident %}Edit{% else %}New{% endif %} Incident - Incident Log System{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-md-12">
            <h2>
                <i class="bi bi-{% if incident %}pencil{% else %}plus-circle{% endif %}"></i>
                {% if incident %}Edit Incident #{{ incident.id }}{% else %}New Incident Log{% endif %}
            </h2>
            <hr>
        </div>
    </div>

    <form method="POST" enctype="multipart/form-data">
        <div class="row">
            <div class="col-md-6">
                <div class="card mb-3">
                    <div class="card-header">
                        <h5><i class="bi bi-info-circle"></i> Incident Information</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="incident_type" class="form-label">Incident Type *</label>
                            <select class="form-select" id="incident_type" name="incident_type" required>
                                {% for itype in get_incident_types(incident.incident_type if incident else None) %}
                                <option value="{{ itype.name }}" {% if (not incident and loop.first) or (incident and incident.incident_type == itype.name) %}selected{% endif %}>
                                    {{ itype.icon }} {{ itype.name }}{% if not itype.is_active %} (Inactive){% endif %}
                                </option>
                                {% endfor %}
                            </select>
                            <div class="form-text">Select the type of incident</div>
                        </div>

                        <div class="mb-3">
                            <label for="incident_datetime" class="form-label">Date & Time *</label>
                            <input type="datetime-local" class="form-control" id="incident_datetime" name="incident_datetime" 
                                   value="{% if incident %}{{ incident.incident_datetime.strftime('%Y-%m-%dT%H:%M') }}{% endif %}" required>
                        </div>

                        <div class="mb-3">
                            <label for="camera_location" class="form-label">Camera Location</label>
                            <input type="text" class="form-control" id="camera_location" name="camera_location" 
                                   value="{{ incident.camera_location if incident else '' }}" placeholder="e.g., Front Entrance, Parking Lot Camera 3">
                        </div>

                        <div class="mb-3">
                            <label for="severity" class="form-label">Severity *</label>
                            <select class="form-select" id="severity" name="severity" required>
                                <option value="Low" {% if incident and incident.severity == 'Low' %}selected{% endif %}>Low</option>
                                <option value="Medium" {% if incident and incident.severity == 'Medium' %}selected{% endif %}>Medium</option>
                                <option value="High" {% if incident and incident.severity == 'High' %}selected{% endif %}>High</option>
                                <option value="Critical" {% if incident and incident.severity == 'Critical' %}selected{% endif %}>Critical</option>
                            </select>
                            <div class="form-text">Select incident severity level</div>
                        </div>

                        <div class="mb-3">
                            <label for="incident_description" class="form-label">Incident Description *</label>
                            <textarea class="form-control" id="incident_description" name="incident_description" rows="4" required>{{ incident.incident_description if incident else '' }}</textarea>
                            <div class="form-text">Provide detailed description of the incident</div>
                        </div>

                        <div class="mb-3">
                            <label for="persons_involved" class="form-label">Persons Involved</label>
                            <textarea class="form-control" id="persons_involved" name="persons_involved" rows="2">{{ incident.persons_involved if incident else '' }}</textarea>
                            <div class="form-text">Names or descriptions of individuals involved</div>
                        </div>

                        <div class="mb-3">
                            <label for="footage_reference" class="form-label">Footage Reference</label>
                            <input type="text" class="form-control" id="footage_reference" name="footage_reference" 
                                   value="{{ incident.footage_reference if incident else '' }}" placeholder="e.g., CAM3_20231121_1430">
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card mb-3">
                    <div class="card-header">
                        <h5><i class="bi bi-clipboard-check"></i> Actions & Review</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="action_taken" class="form-label">Action Taken</label>
                            <textarea class="form-control" id="action_taken" name="action_taken" rows="3">{{ incident.action_taken if incident else '' }}</textarea>
                            <div class="form-text">Describe actions taken in response to the incident</div>
                        </div>

                        <div class="mb-3">
                            <label for="reported_by" class="form-label">Reported By</label>
                            <input type="text" class="form-control" id="reported_by" name="reported_by" 
                                   value="{{ incident.reported_by if incident else (current_user.full_name or current_user.username) }}">
                        </div>

                        <div class="mb-3">
                            <label for="reviewed_by" class="form-label">Reviewed By</label>
                            <input type="text" class="form-control" id="reviewed_by" name="reviewed_by" 
                                   value="{{ incident.reviewed_by if incident else '' }}">
                        </div>

                        <div class="mb-3">
                            <label for="remarks_outcome" class="form-label">Remarks / Outcome</label>
                            <textarea class="form-control" id="remarks_outcome" name="remarks_outcome" rows="3">{{ incident.remarks_outcome if incident else '' }}</textarea>
                        </div>
                    </div>
                </div>

                <div class="card mb-3">
                    <div class="card-header">
                        <h5><i class="bi bi-paperclip"></i> File Attachments</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Upload Files (Images/Videos)</label>
                            <input type="file" class="d-none" id="fileInput" accept=".jpg,.jpeg,.bmp,.mp4,.avi,.mov" multiple onchange="addFilesToQueue()">
                            
                            <div class="d-grid gap-2">
                                <button type="button" class="btn btn-outline-primary" onclick="document.getElementById('fileInput').click()">
                                    <i class="bi bi-plus-circle"></i> Add Files (can add from multiple folders)
                                </button>
                            </div>
                            
                            <div class="form-text">
                                <strong>Click "Add Files" multiple times to select from different folders.</strong><br>
                                Images: JPG, BMP | Videos: MP4, AVI, MOV | Max total: 1GB<br>
                                <small class="text-info"><i class="bi bi-info-circle"></i> You can also hold <kbd>Ctrl</kbd> (Windows/Linux) or <kbd>âŒ˜</kbd> (Mac) to select multiple files at once</small>
                            </div>
                            
                            <div id="fileQueue" class="mt-3"></div>
                            
                            <div id="uploadProgress" class="mt-3" style="display: none;">
                                <div class="alert alert-info">
                                    <strong><i class="bi bi-cloud-upload"></i> Uploading files...</strong>
                                    <div class="progress mt-2" style="height: 25px;">
                                        <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                                             role="progressbar" style="width: 100%">
                                            Please wait...
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        {% if incident %}
                            {% if incident.attachments %}
                            <div class="mt-3">
                                <h6>Current Attachments:</h6>
                                <div class="list-group">
                                    {% for attachment in incident.attachments %}
                                    <div class="list-group-item d-flex justify-content-between align-items-center">
                                        <span>
                                            {% if attachment.file_type == 'image' %}
                                            <i class="bi bi-image text-primary"></i>
                                            {% else %}
                                            <i class="bi bi-camera-video text-danger"></i>
                                            {% endif %}
                                            {{ attachment.filename }}
                                            <small class="text-muted">({{ (attachment.file_size / 1024 / 1024) | round(2) }} MB)</small>
                                        </span>
                                        <a href="{{ url_for('uploaded_file', filename=attachment.filename) }}" 
                                           target="_blank" class="btn btn-sm btn-outline-primary">
                                            <i class="bi bi-eye"></i> View
                                        </a>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% elif incident.attachment_filename %}
                            <div class="mt-3">
                                <h6>Legacy Attachment:</h6>
                                <div class="list-group">
                                    <div class="list-group-item d-flex justify-content-between align-items-center">
                                        <span>
                                            <i class="bi bi-image text-primary"></i>
                                            {{ incident.attachment_filename }}
                                        </span>
                                        <a href="{{ url_for('uploaded_file', filename=incident.attachment_filename) }}" 
                                           target="_blank" class="btn btn-sm btn-outline-primary">
                                            <i class="bi bi-eye"></i> View
                                        </a>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-12">
                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-save"></i> {% if incident %}Update{% else %}Create{% endif %} Incident
                    </button>
                    <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">
                        <i class="bi bi-x-circle"></i> Cancel
                    </a>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
// File queue for accumulating files from multiple folders
let fileQueue = [];

function addFilesToQueue() {
    const fileInput = document.getElementById('fileInput');
    const files = Array.from(fileInput.files);
    
    // Add new files to queue
    files.forEach(file => {
        // Check for duplicates by name
        const isDuplicate = fileQueue.some(f => f.name === file.name && f.size === file.size);
        if (!isDuplicate) {
            fileQueue.push(file);
        }
    });
    
    // Clear the input so user can select from another folder
    fileInput.value = '';
    
    // Update display
    displayFileQueue();
}

function removeFileFromQueue(index) {
    fileQueue.splice(index, 1);
    displayFileQueue();
}

function displayFileQueue() {
    const queueDiv = document.getElementById('fileQueue');
    
    if (fileQueue.length === 0) {
        queueDiv.innerHTML = '';
        return;
    }
    
    let totalSize = fileQueue.reduce((sum, file) => sum + file.size, 0);
    let totalSizeMB = (totalSize / (1024 * 1024)).toFixed(2);
    
    let html = `<div class="card">
        <div class="card-header bg-light">
            <strong><i class="bi bi-paperclip"></i> Files to Upload (${fileQueue.length})</strong>
            <span class="badge bg-info ms-2">${totalSizeMB} MB total</span>
        </div>
        <div class="list-group list-group-flush">`;
    
    fileQueue.forEach((file, index) => {
        const sizeMB = (file.size / (1024 * 1024)).toFixed(2);
        const icon = file.type.startsWith('image/') ? 'bi-image text-primary' : 'bi-camera-video text-danger';
        html += `
            <div class="list-group-item d-flex justify-content-between align-items-center">
                <span>
                    <i class="bi ${icon}"></i> ${file.name}
                    <small class="text-muted">(${sizeMB} MB)</small>
                </span>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeFileFromQueue(${index})">
                    <i class="bi bi-trash"></i> Remove
                </button>
            </div>`;
    });
    
    html += '</div></div>';
    queueDiv.innerHTML = html;
}

// Handle form submission
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form[method="POST"]');
    
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Show progress indicator if there are files
        if (fileQueue.length > 0) {
            document.getElementById('uploadProgress').style.display = 'block';
            
            // Disable submit button
            const submitBtn = form.querySelector('button[type="submit"]');
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Uploading...';
            }
        }
        
        // Create FormData from the form
        const formData = new FormData(form);
        
        // Remove any existing attachments field
        formData.delete('attachments');
        
        // Add files from queue
        fileQueue.forEach(file => {
            formData.append('attachments', file);
        });
        
        // Submit the form
        fetch(form.action, {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (response.redirected) {
                window.location.href = response.url;
            } else {
                return response.text().then(html => {
                    document.open();
                    document.write(html);
                    document.close();
                });
            }
        })
        .catch(error => {
            console.error('Upload error:', error);
            alert('Error uploading files. Please try again.');
            document.getElementById('uploadProgress').style.display = 'none';
            const submitBtn = form.querySelector('button[type="submit"]');
            if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="bi bi-save"></i> {% if incident %}Update{% else %}Create{% endif %} Incident';
            }
        });
    });
});
</script>
{% endblock %}
