# Ubuntu Deployment Guide - Incident Log System

Complete deployment instructions for Ubuntu LAN server with automatic systemd service setup.

## üöÄ Quick Start (One-Command Deployment)

### Prerequisites
- Ubuntu 20.04+ server
- Internet connection for package installation
- Sudo access

### Installation Steps

```bash
# 1. Clone the repository
git clone <your-github-repo-url> /home/lulo/Incident-Report
cd /home/lulo/Incident-Report

# 2. Run the automated setup script
sudo bash deploy-ubuntu.sh

# 3. Access your application
# The script will display:
# - Application URL: http://<your-server-ip>:5000
# - Admin username and password
```

**That's it!** The application is now running and will automatically start after server reboots.

---

## üìã What the Setup Script Does

The `deploy-ubuntu.sh` script automatically:

1. ‚úÖ Installs system dependencies (Python 3.11+, virtualenv, OpenSSL)
2. ‚úÖ Creates Python virtual environment
3. ‚úÖ Installs all Python packages from requirements.txt
4. ‚úÖ **Generates secure SESSION_SECRET automatically**
5. ‚úÖ Creates systemd service with embedded SESSION_SECRET
6. ‚úÖ Creates log directory with proper permissions
7. ‚úÖ Enables auto-start on boot
8. ‚úÖ Starts the application immediately
9. ‚úÖ Displays admin credentials and access URL

---

## üîë Admin Credentials

After deployment, the script will display:

```
================================================================================
üéâ Deployment Complete!
================================================================================
Application URL: http://192.168.5.43:5000
Admin Username:  admin
Admin Password:  <randomly-generated-password>
================================================================================
‚ö†Ô∏è  SAVE THIS PASSWORD NOW - It will not be shown again!
================================================================================
```

**Critical**: Save the admin password immediately - it's only displayed once.

---

## üîß Service Management

The application runs as a systemd service named `incident-log`.

### Check Status
```bash
sudo systemctl status incident-log
```

### View Live Logs
```bash
# Application logs
sudo tail -f /var/log/incident-log/app.log

# Error logs
sudo tail -f /var/log/incident-log/error.log
```

### Control Service
```bash
# Start
sudo systemctl start incident-log

# Stop
sudo systemctl stop incident-log

# Restart (after code updates)
sudo systemctl restart incident-log

# Disable auto-start
sudo systemctl disable incident-log

# Enable auto-start
sudo systemctl enable incident-log
```

---

## üåê Network Access

### From the Server
```bash
curl http://localhost:5000
```

### From LAN Computers

1. Find server IP address:
```bash
ip addr show | grep inet
```

2. Access from browser on any LAN computer:
```
http://<server-ip>:5000
```

### Firewall Configuration

If you can't access from other computers:

```bash
# Allow port 5000
sudo ufw allow 5000

# Check firewall status
sudo ufw status
```

---

## üîÑ Automatic Backups Setup

After logging in as admin:

1. Navigate to **Backup ‚Üí Backup Settings**
2. Configure your backup destination:
   - **Local Path**: Use a mounted network share (e.g., `/mnt/backups`)
   - **SMB Share**: Direct network share connection

### For SMB/CIFS Network Shares

If using SMB backup, add credentials to the systemd service:

```bash
# Edit the service file
sudo nano /etc/systemd/system/incident-log.service
```

Add these lines under `[Service]` section:

```ini
Environment="SMB_USERNAME=your_network_username"
Environment="SMB_PASSWORD=your_network_password"
```

Reload and restart:

```bash
sudo systemctl daemon-reload
sudo systemctl restart incident-log
```

---

## üîÑ Updating the Application

When you pull new code from GitHub:

```bash
cd /home/lulo/Incident-Report

# Pull latest code
git pull

# Activate virtual environment
source venv/bin/activate

# Update dependencies (if requirements.txt changed)
pip install -r requirements.txt

# Restart the service
sudo systemctl restart incident-log

# Check status
sudo systemctl status incident-log
```

---

## üõ†Ô∏è Troubleshooting

### Service Won't Start

Check the error logs:

```bash
sudo journalctl -u incident-log -n 50 --no-pager
```

Common issues:

1. **Missing SESSION_SECRET**: Should be auto-generated by deploy script
2. **Python dependencies**: Run `source venv/bin/activate && pip install -r requirements.txt`
3. **Permission issues**: Run `sudo chown -R lulo:lulo /home/lulo/Incident-Report`
4. **Port already in use**: Check if another process is using port 5000

### Can't Access from Other Computers

```bash
# Check if service is running
sudo systemctl status incident-log

# Check firewall
sudo ufw status
sudo ufw allow 5000

# Verify server IP
ip addr show

# Test from another computer
ping <server-ip>
telnet <server-ip> 5000
```

### Database Errors

```bash
# Backup current database
cp /home/lulo/Incident-Report/instance/incidents.db /home/lulo/Incident-Report/instance/incidents.db.backup

# If needed, reset database (WARNING: deletes all data)
rm /home/lulo/Incident-Report/instance/incidents.db

# Restart service (will recreate database with default admin)
sudo systemctl restart incident-log
```

### Forgot Admin Password

```bash
# Stop the service
sudo systemctl stop incident-log

# Reset database to get new admin password
cd /home/lulo/Incident-Report
rm instance/incidents.db

# Start service and check logs for new password
sudo systemctl start incident-log
sudo tail -f /var/log/incident-log/app.log
# Look for "IMPORTANT: Default admin user created" message
```

---

## üìÅ File Locations

| Item | Location |
|------|----------|
| Application Code | `/home/lulo/Incident-Report/` |
| Virtual Environment | `/home/lulo/Incident-Report/venv/` |
| Database | `/home/lulo/Incident-Report/instance/incidents.db` |
| Uploaded Files | `/home/lulo/Incident-Report/uploads/` |
| Application Logs | `/var/log/incident-log/app.log` |
| Error Logs | `/var/log/incident-log/error.log` |
| Systemd Service | `/etc/systemd/system/incident-log.service` |

---

## üîê Security Notes

### Production Deployment

For production use on a LAN:

1. **Firewall**: Restrict access to port 5000 to LAN IPs only
2. **SESSION_SECRET**: Automatically generated and stored securely in service file
3. **Admin Password**: Strong 20-character random password generated on first run
4. **Backups**: Configure automated backups to network share
5. **SSL/HTTPS**: Consider nginx reverse proxy with SSL for sensitive deployments

### Environment Secrets

The deployment script stores `SESSION_SECRET` in the systemd service file at:
```
/etc/systemd/system/incident-log.service
```

Only root can read this file, keeping the secret secure.

For SMB credentials, add them to the same file:
```ini
Environment="SMB_USERNAME=your_username"
Environment="SMB_PASSWORD=your_password"
```

---

## üÜò Getting Help

### Check Service Status
```bash
sudo systemctl status incident-log
```

### View Recent Logs
```bash
sudo journalctl -u incident-log -n 100 --no-pager
```

### Test Application Manually
```bash
cd /home/lulo/Incident-Report
source venv/bin/activate
python app.py
# Press Ctrl+C to stop, then restart service
```

---

## üì¶ Manual Installation (Advanced)

If you prefer manual setup instead of the automated script:

### 1. Install Dependencies
```bash
sudo apt update
sudo apt install python3-full python3-venv python3-pip openssl -y
```

### 2. Create Virtual Environment
```bash
cd /home/lulo/Incident-Report
python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt
```

### 3. Generate SESSION_SECRET
```bash
export SESSION_SECRET="$(openssl rand -hex 32)"
echo "Your SESSION_SECRET: $SESSION_SECRET"
# SAVE THIS VALUE
```

### 4. Create Systemd Service
```bash
sudo nano /etc/systemd/system/incident-log.service
```

Paste this content (replace `<your-session-secret>` with the value from step 3):

```ini
[Unit]
Description=Incident Log System
After=network.target

[Service]
Type=simple
User=lulo
WorkingDirectory=/home/lulo/Incident-Report
Environment="PATH=/home/lulo/Incident-Report/venv/bin:/usr/local/bin:/usr/bin:/bin"
Environment="SESSION_SECRET=<your-session-secret>"
ExecStart=/home/lulo/Incident-Report/venv/bin/python /home/lulo/Incident-Report/app.py
Restart=always
RestartSec=10
StandardOutput=append:/var/log/incident-log/app.log
StandardError=append:/var/log/incident-log/error.log

[Install]
WantedBy=multi-user.target
```

### 5. Create Log Directory
```bash
sudo mkdir -p /var/log/incident-log
sudo chown lulo:lulo /var/log/incident-log
```

### 6. Enable and Start Service
```bash
sudo systemctl daemon-reload
sudo systemctl enable incident-log
sudo systemctl start incident-log
sudo systemctl status incident-log
```

---

## ‚úÖ Post-Deployment Checklist

- [ ] Service is running: `sudo systemctl status incident-log`
- [ ] Can access login page from server: `curl http://localhost:5000`
- [ ] Can access from LAN computer in browser
- [ ] Saved admin password securely
- [ ] Logged in successfully as admin
- [ ] Configured backup settings
- [ ] Tested backup creation
- [ ] Firewall configured (if needed)
- [ ] Auto-start verified: `sudo systemctl is-enabled incident-log` shows "enabled"

---

## üéØ Summary

The automated deployment script makes it simple:

```bash
git clone <repo> /home/lulo/Incident-Report
cd /home/lulo/Incident-Report
sudo bash deploy-ubuntu.sh
```

This gives you:
- ‚úÖ Production-ready Flask application
- ‚úÖ Automatic startup after server reboot
- ‚úÖ Automatic restart if app crashes
- ‚úÖ Secure session secret generation
- ‚úÖ Proper logging to `/var/log/incident-log/`
- ‚úÖ Service management via systemctl

**Your incident logging system is now production-ready!**
